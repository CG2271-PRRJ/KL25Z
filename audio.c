#include "audio.h"

volatile int currNoteAlt = 0;
volatile int currNoteMain = 0;

int melody[] = {
    D5,
    D5,
    D6,
    A5,
    0,
    GS5,
    G5,
    F5,
    D5,
    F5,
    G5,
    C5,
    C5,
    D6,
    A5,
    0,
    GS5,
    G5,
    F5,
    D5,
    F5,
    G5,
    B4,
    B4,
    D6,
    A5,
    0,
    GS5,
    G5,
    F5,
    D5,
    F5,
    G5,
    AS4,
    AS4,
    D6,
    A5,
    0,
    GS5,
    G5,
    F5,
    D5,
    F5,
    G5,
    D5,
    D5,
    D6,
    A5,
    0,
    GS5,
    G5,
    F5,
    D5,
    F5,
    G5,
    C5,
    C5,
    D6,
    A5,
    0,
    GS5,
    G5,
    F5,
    D5,
    F5,
    G5,
    B4,
    B4,
    D6,
    A5,
    0,
    GS5,
    G5,
    F5,
    D5,
    F5,
    G5,
    AS4,
    AS4,
    D6,
    A5,
    0,
    GS5,
    G5,
    F5,
    D5,
    F5,
    G5,
    D6,
    D6,
    D7,
    A6,
    0,
    GS6,
    G6,
    F6,
    D6,
    F6,
    G6,
    C6,
    C6,
    D7,
    A6,
    0,
    GS6,
    G6,
    F6,
    D6,
    F6,
    G6,
    B5,
    B5,
    D7,
    A6,
    0,
    GS6,
    G6,
    F6,
    D6,
    F6,
    G6,
    AS5,
    AS5,
    D7,
    A6,
    0,
    GS6,
    G6,
    F6,
    D6,
    F6,
    G6,
    D6,
    D6,
    D7,
    A6,
    0,
    GS6,
    G6,
    F6,
    D6,
    F6,
    G6,
    C6,
    C6,
    D7,
    A6,
    0,
    GS6,
    G6,
    F6,
    D6,
    F6,
    G6,
    B5,
    B5,
    D7,
    A6,
    0,
    GS6,
    G6,
    F6,
    D6,
    F6,
    G6,
    AS5,
    AS5,
    D7,
    A6,
    0,
    GS6,
    G6,
    F6,
    D6,
    F6,
    G6,
    F6,
    F6,
    F6,
    F6,
    F6,
    D6,
    D6,
    D6,
    F6,
    F6,
    F6,
    G6,
    GS6,
    G6,
    F6,
    D6,
    F6,
    G6,
    0,
    F6,
    F6,
    F6,
    G6,
    GS6,
    A6,
    C7,
    A6,
    D7,
    D7,
    D7,
    A6,
    D7,
    C7,
    F6,
    F6,
    F6,
    F6,
    F6,
    D6,
    D6,
    D6,
    F6,
    F6,
    F6,
    F6,
    D6,
    F6,
    E6,
    D6,
    C6,
    0,
    G6,
    E6,
    D6,
    D6,
    D6,
    D6,
    F5,
    G5,
    AS5,
    C6,
    D6,
    F6,
    C7,
    0,
    F6,
    D6,
    F6,
    G6,
    GS6,
    G6,
    F6,
    D6,
    GS6,
    G6,
    F6,
    D6,
    F6,
    F6,
    F6,
    GS6,
    A6,
    C7,
    A6,
    GS6,
    G6,
    F6,
    D6,
    E6,
    F6,
    G6,
    A6,
    C7,
    CS7,
    GS6,
    GS6,
    G6,
    F6,
    G6,
    F5,
    G5,
    A5,
    F6,
    E6,
    D6,
    E6,
    F6,
    G6,
    E6,
    A6,
    A6,
    G6,
    F6,
    DS6,
    CS6,
    DS6,
    0,
    F6,
    D6,
    F6,
    G6,
    GS6,
    G6,
    F6,
    D6,
    GS6,
    G6,
    F6,
    D6,
    F6,
    F6,
    F6,
    GS6,
    A6,
    C7,
    A6,
    GS6,
    G6,
    F6,
    D6,
    E6,
    F6,
    G6,
    A6,
    C7,
    CS7,
    GS6,
    GS6,
    G6,
    F6,
    G6,
    F5,
    G5,
    A5,
    F6,
    E6,
    D6,
    E6,
    F6,
    G6,
    E6,
    A6,
    A6,
    G6,
    F6,
    DS6,
    CS6,
    DS6,
};

int durations[] = {
    16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 8, 16, 8, 8, 8, 8, 4, 16, 8, 16, 8, 8, 8, 16, 16, 16, 16, 16, 8, 8, 16, 8, 8, 8, 8, 8, 8, 8, 8, 16, 16, 16, 2, 8, 16, 8, 8, 8, 8, 4, 16, 8, 16, 8, 8, 8, 8, 8, 16, 8, 16, 8, 8, 8, 8, 8, 8, 8, 16, 8, 15, 8, 8, 2, 3, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 8, 2, 16, 8, 16, 8, 16, 16, 16, 16, 16, 16, 8, 8, 8, 8, 8, 8, 16, 16, 16, 2, 8, 8, 8, 8, 4, 4, 4, 4, 4, 4, 2, 8, 8, 8, 8, 2, 2, 3, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 8, 2, 16, 8, 16, 8, 16, 16, 16, 16, 16, 16, 8, 8, 8, 8, 8, 8, 16, 16, 16, 2, 8, 8, 8, 8, 4, 4, 4, 4, 4, 4, 2, 8, 8, 8, 8, 2, 1};

#define DEJAVU_LEN 200
#define DEJAVU_SPEED 0.6

int dejavu[DEJAVU_LEN][2] = {
    {REST, ONE_BEAT}, {AS6, HALF_BEAT}, {AS6, ONE_BEAT}, {F6, ONE_BEAT}, {REST, ONE_BEAT}, {AS6, HALF_BEAT}, {AS6, ONE_BEAT}, {F6, ONE_BEAT}, {REST, HALF_BEAT}, {AS5, HALF_BEAT}, {D6, HALF_BEAT}, {AS5, HALF_BEAT}, {D6, HALF_BEAT}, {AS5, HALF_BEAT}, {D6, HALF_BEAT}, {DS6, ONE_HALF_BEAT}, {REST, HALF_BEAT}, {G6, ONE_BEAT}, {F6, HALF_BEAT}, {DS6, HALF_BEAT}, {D6, HALF_BEAT}, {REST, ONE_BEAT}, {AS6, HALF_BEAT}, {AS6, ONE_BEAT}, {F6, ONE_BEAT}, {REST, ONE_BEAT}, {DS5, HALF_BEAT}, {DS5, HALF_BEAT}, {D5, HALF_BEAT}, {C5, HALF_BEAT}, {AS4, ONE_BEAT}, // 6
    {C5, ONE_BEAT},
    {C5, HALF_BEAT},
    {F5, QUARTER_BEAT},
    {G5, QUARTER_BEAT},
    {C6, QUARTER_BEAT},
    {C6, QUARTER_BEAT},
    {F6, QUARTER_BEAT},
    {G6, QUARTER_BEAT},
    {C7, QUARTER_BEAT},
    {C7, QUARTER_BEAT},
    {F7, QUARTER_BEAT},
    {G7, QUARTER_BEAT},
    {C8, HALF_BEAT},
    {REST, ONE_HALF_BEAT},
    {REST, HALF_BEAT},
    {C6, HALF_BEAT},
    {D6, HALF_BEAT},
    {DS6, ONE_HALF_BEAT}, // 6
    {DS6, HALF_BEAT},
    {DS6, HALF_BEAT},
    {DS6, HALF_BEAT},
    {AS5, HALF_BEAT},
    {G5, HALF_BEAT},
    {AS5, ONE_BEAT}, // 6
    {C6, HALF_BEAT},
    {C6, ONE_BEAT},
    {G6, HALF_BEAT},
    {F6, HALF_BEAT},
    {DS6, HALF_BEAT},
    {D6, HALF_BEAT}, // 6
    {DS6, ONE_BEAT},
    {DS6, HALF_BEAT},
    {DS6, HALF_BEAT},
    {F6, HALF_BEAT},
    {DS6, HALF_BEAT},
    {F6, HALF_BEAT},
    {F6, ONE_BEAT}, // 7
    {G6, HALF_BEAT},
    {G6, HALF_BEAT},
    {F6, ONE_BEAT},
    {C6, HALF_BEAT},
    {D6, HALF_BEAT},
    {DS6, ONE_HALF_BEAT}, // 6
    {DS6, HALF_BEAT},
    {DS6, HALF_BEAT},
    {F6, HALF_BEAT},
    {D6, HALF_BEAT},
    {AS5, HALF_BEAT},
    {AS5, ONE_BEAT}, // 6
    {C6, HALF_BEAT},
    {C6, ONE_BEAT},
    {DS6, HALF_BEAT},
    {D6, HALF_BEAT},
    {C6, HALF_BEAT},
    {AS5, HALF_BEAT}, // 6
    {C6, ONE_BEAT},
    {DS7, HALF_BEAT},
    {DS7, HALF_BEAT},
    {F7, HALF_BEAT},
    {DS7, HALF_BEAT},
    {F7, HALF_BEAT},
    {F7, ONE_BEAT}, // 7
    {G7, HALF_BEAT},
    {G7, HALF_BEAT},
    {F7, TWO_BEAT}, // 3
    {G7, HALF_BEAT},
    {REST, HALF_BEAT},
    {G7, HALF_BEAT},
    {REST, HALF_BEAT},
    {G7, HALF_BEAT},
    {G7, TWO_BEAT},  // 6
    {REST, TWO_BEAT} // 1
};

void setNote(uint32_t freq)
{
    if (freq == 0)
    {
        stopNote();
        return;
    }
    uint32_t mod = (375000 / (freq));
    TPM0->MOD = mod;
    TPM0_C5V = mod / VOLUME;
}

void stopNote(void)
{
    TPM0_C5V = 0;
}

uint16_t changeNoteAlt(void)
{
    setNote(dejavu[currNoteAlt][0]);

    // calculate delay bASed on tempo and note length
    uint16_t note_length = dejavu[currNoteAlt][1];
    uint16_t delay = (uint16_t)((double)(TEMPO / note_length) * 0.9);

    currNoteAlt = (currNoteAlt + 1) % DEJAVU_LEN;
    return delay;
}

uint16_t changeNoteMain(void)
{
    setNote(melody[currNoteMain]);

    // calculate delay bASed on tempo and note length
    uint16_t note_length = durations[currNoteMain];
    uint16_t delay = (uint16_t)((double)(TEMPO / note_length) * 1.45);

    currNoteMain = (currNoteMain + 1) % (sizeof(melody) / sizeof(int));
    return delay;
}
