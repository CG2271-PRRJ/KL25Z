#include "audio.h"

volatile int currNoteAlt = 0;

int melody[] = {
    N_D5,
    N_D5,
    N_D6,
    N_A5,
    0,
    N_GS5,
    N_G5,
    N_F5,
    N_D5,
    N_F5,
    N_G5,
    N_C5,
    N_C5,
    N_D6,
    N_A5,
    0,
    N_GS5,
    N_G5,
    N_F5,
    N_D5,
    N_F5,
    N_G5,
    N_B4,
    N_B4,
    N_D6,
    N_A5,
    0,
    N_GS5,
    N_G5,
    N_F5,
    N_D5,
    N_F5,
    N_G5,
    N_AS4,
    N_AS4,
    N_D6,
    N_A5,
    0,
    N_GS5,
    N_G5,
    N_F5,
    N_D5,
    N_F5,
    N_G5,
    N_D5,
    N_D5,
    N_D6,
    N_A5,
    0,
    N_GS5,
    N_G5,
    N_F5,
    N_D5,
    N_F5,
    N_G5,
    N_C5,
    N_C5,
    N_D6,
    N_A5,
    0,
    N_GS5,
    N_G5,
    N_F5,
    N_D5,
    N_F5,
    N_G5,
    N_B4,
    N_B4,
    N_D6,
    N_A5,
    0,
    N_GS5,
    N_G5,
    N_F5,
    N_D5,
    N_F5,
    N_G5,
    N_AS4,
    N_AS4,
    N_D6,
    N_A5,
    0,
    N_GS5,
    N_G5,
    N_F5,
    N_D5,
    N_F5,
    N_G5,
    N_D6,
    N_D6,
    N_D7,
    N_A6,
    0,
    N_GS6,
    N_G6,
    N_F6,
    N_D6,
    N_F6,
    N_G6,
    N_C6,
    N_C6,
    N_D7,
    N_A6,
    0,
    N_GS6,
    N_G6,
    N_F6,
    N_D6,
    N_F6,
    N_G6,
    N_B5,
    N_B5,
    N_D7,
    N_A6,
    0,
    N_GS6,
    N_G6,
    N_F6,
    N_D6,
    N_F6,
    N_G6,
    N_AS5,
    N_AS5,
    N_D7,
    N_A6,
    0,
    N_GS6,
    N_G6,
    N_F6,
    N_D6,
    N_F6,
    N_G6,
    N_D6,
    N_D6,
    N_D7,
    N_A6,
    0,
    N_GS6,
    N_G6,
    N_F6,
    N_D6,
    N_F6,
    N_G6,
    N_C6,
    N_C6,
    N_D7,
    N_A6,
    0,
    N_GS6,
    N_G6,
    N_F6,
    N_D6,
    N_F6,
    N_G6,
    N_B5,
    N_B5,
    N_D7,
    N_A6,
    0,
    N_GS6,
    N_G6,
    N_F6,
    N_D6,
    N_F6,
    N_G6,
    N_AS5,
    N_AS5,
    N_D7,
    N_A6,
    0,
    N_GS6,
    N_G6,
    N_F6,
    N_D6,
    N_F6,
    N_G6,
    N_F6,
    N_F6,
    N_F6,
    N_F6,
    N_F6,
    N_D6,
    N_D6,
    N_D6,
    N_F6,
    N_F6,
    N_F6,
    N_G6,
    N_GS6,
    N_G6,
    N_F6,
    N_D6,
    N_F6,
    N_G6,
    0,
    N_F6,
    N_F6,
    N_F6,
    N_G6,
    N_GS6,
    N_A6,
    N_C7,
    N_A6,
    N_D7,
    N_D7,
    N_D7,
    N_A6,
    N_D7,
    N_C7,
    N_F6,
    N_F6,
    N_F6,
    N_F6,
    N_F6,
    N_D6,
    N_D6,
    N_D6,
    N_F6,
    N_F6,
    N_F6,
    N_F6,
    N_D6,
    N_F6,
    N_E6,
    N_D6,
    N_C6,
    0,
    N_G6,
    N_E6,
    N_D6,
    N_D6,
    N_D6,
    N_D6,
    N_F5,
    N_G5,
    N_AS5,
    N_C6,
    N_D6,
    N_F6,
    N_C7,
    0,
    N_F6,
    N_D6,
    N_F6,
    N_G6,
    N_GS6,
    N_G6,
    N_F6,
    N_D6,
    N_GS6,
    N_G6,
    N_F6,
    N_D6,
    N_F6,
    N_F6,
    N_F6,
    N_GS6,
    N_A6,
    N_C7,
    N_A6,
    N_GS6,
    N_G6,
    N_F6,
    N_D6,
    N_E6,
    N_F6,
    N_G6,
    N_A6,
    N_C7,
    N_CS7,
    N_GS6,
    N_GS6,
    N_G6,
    N_F6,
    N_G6,
    N_F5,
    N_G5,
    N_A5,
    N_F6,
    N_E6,
    N_D6,
    N_E6,
    N_F6,
    N_G6,
    N_E6,
    N_A6,
    N_A6,
    N_G6,
    N_F6,
    N_DS6,
    N_CS6,
    N_DS6,
    0,
    N_F6,
    N_D6,
    N_F6,
    N_G6,
    N_GS6,
    N_G6,
    N_F6,
    N_D6,
    N_GS6,
    N_G6,
    N_F6,
    N_D6,
    N_F6,
    N_F6,
    N_F6,
    N_GS6,
    N_A6,
    N_C7,
    N_A6,
    N_GS6,
    N_G6,
    N_F6,
    N_D6,
    N_E6,
    N_F6,
    N_G6,
    N_A6,
    N_C7,
    N_CS7,
    N_GS6,
    N_GS6,
    N_G6,
    N_F6,
    N_G6,
    N_F5,
    N_G5,
    N_A5,
    N_F6,
    N_E6,
    N_D6,
    N_E6,
    N_F6,
    N_G6,
    N_E6,
    N_A6,
    N_A6,
    N_G6,
    N_F6,
    N_DS6,
    N_CS6,
    N_DS6,
};

int durations[] = {
    16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 16, 16, 8, 6, 32, 8, 8, 8, 16, 16, 16, 8, 16, 8, 8, 8, 8, 4, 16, 8, 16, 8, 8, 8, 16, 16, 16, 16, 16, 8, 8, 16, 8, 8, 8, 8, 8, 8, 8, 8, 16, 16, 16, 2, 8, 16, 8, 8, 8, 8, 4, 16, 8, 16, 8, 8, 8, 8, 8, 16, 8, 16, 8, 8, 8, 8, 8, 8, 8, 16, 8, 15, 8, 8, 2, 3, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 8, 2, 16, 8, 16, 8, 16, 16, 16, 16, 16, 16, 8, 8, 8, 8, 8, 8, 16, 16, 16, 2, 8, 8, 8, 8, 4, 4, 4, 4, 4, 4, 2, 8, 8, 8, 8, 2, 2, 3, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 8, 2, 16, 8, 16, 8, 16, 16, 16, 16, 16, 16, 8, 8, 8, 8, 8, 8, 16, 16, 16, 2, 8, 8, 8, 8, 4, 4, 4, 4, 4, 4, 2, 8, 8, 8, 8, 2, 1};

// int melody[] = {
//     NOTE_A5,
//     NOTE_B5,
//     NOTE_C6,
//     NOTE_D6,
// };

// int durations[] = {
//     4, 4, 4, 4};
void setNote(uint32_t freq)
{
    if (freq == 0)
    {
        stopNote();
        return;
    }
    uint32_t mod = (375000 / (freq));
    TPM0->MOD = mod;
    TPM0_C5V = mod / VOLUME;
}

void stopNote(void)
{
    TPM0_C5V = 0;
}

uint16_t changeNoteAlt(void)
{
    setNote(melody[currNoteAlt]);

    // calculate delay based on tempo and note length
    uint16_t note_length = durations[currNoteAlt];
    uint16_t delay = (uint16_t)((double)(TEMPO / note_length) * 1.45);

    currNoteAlt = (currNoteAlt + 1) % (sizeof(melody) / sizeof(int));
    return delay;
}